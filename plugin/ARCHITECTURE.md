# QuantMesh 插件系统架构

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         QuantMesh 主程序                                 │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                      核心模块 (开源)                            │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │    │
│  │  │ Exchange │  │ Monitor  │  │  Order   │  │ Position │      │    │
│  │  │  Layer   │  │  System  │  │ Executor │  │ Manager  │      │    │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘      │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                    插件系统 (开源框架)                          │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │    │
│  │  │   Plugin     │  │   License    │  │   Plugin     │        │    │
│  │  │  Registry    │  │  Validator   │  │   Loader     │        │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘        │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                    策略管理器                                    │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │    │
│  │  │   Strategy   │  │   Capital    │  │   Dynamic    │        │    │
│  │  │   Manager    │  │  Allocator   │  │  Allocator   │        │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘        │    │
│  └────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                  ↓
                        插件接口 (Plugin Interface)
                                  ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                           插件层                                         │
│                                                                          │
│  ┌────────────────────────────┐  ┌────────────────────────────┐        │
│  │      免费插件 (开源)        │  │     商业插件 (闭源)         │        │
│  │  ┌──────────────────────┐  │  │  ┌──────────────────────┐  │        │
│  │  │  Example Strategy    │  │  │  │  Premium AI Strategy │  │        │
│  │  │  - 示例网格策略       │  │  │  │  - AI决策引擎        │  │        │
│  │  │  - 教学用途           │  │  │  │  - 机器学习优化      │  │        │
│  │  │  - 社区贡献           │  │  │  │  - 需要商业许可证    │  │        │
│  │  └──────────────────────┘  │  │  └──────────────────────┘  │        │
│  │                             │  │                             │        │
│  │  ┌──────────────────────┐  │  │  ┌──────────────────────┐  │        │
│  │  │  Trend Following     │  │  │  │  ML Optimizer        │  │        │
│  │  │  - 趋势跟踪策略       │  │  │  │  - 参数自动优化      │  │        │
│  │  └──────────────────────┘  │  │  └──────────────────────┘  │        │
│  │                             │  │                             │        │
│  │  ┌──────────────────────┐  │  │  ┌──────────────────────┐  │        │
│  │  │  Signal Plugin       │  │  │  │  Sentiment Analyzer  │  │        │
│  │  │  - 信号源接入         │  │  │  │  - 市场情绪分析      │  │        │
│  │  └──────────────────────┘  │  │  └──────────────────────┘  │        │
│  └────────────────────────────┘  └────────────────────────────┘        │
│         GitHub Public                  GitHub Private                   │
└─────────────────────────────────────────────────────────────────────────┘
                                  ↓
                        许可证验证 (License Validation)
                                  ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                       许可证系统 (可选)                                  │
│  ┌────────────────────────────┐  ┌────────────────────────────┐        │
│  │    本地验证                 │  │    在线验证 (可选)          │        │
│  │  - 加密存储                 │  │  - 实时验证                 │        │
│  │  - 签名校验                 │  │  - 使用统计                 │        │
│  │  - 过期检查                 │  │  - 远程撤销                 │        │
│  │  - 机器绑定                 │  │  - 自动更新                 │        │
│  └────────────────────────────┘  └────────────────────────────┘        │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🔄 数据流

### 1. 插件加载流程

```
启动 main.go
    ↓
创建 PluginLoader
    ↓
加载配置 (config.yaml)
    ↓
┌─────────────────────────────────────┐
│ 对每个启用的插件:                    │
│   1. 创建插件实例                    │
│   2. 验证许可证 (如需要)             │
│   3. 初始化插件                      │
│   4. 注册到 PluginRegistry           │
│   5. 获取策略实例                    │
│   6. 注册到 StrategyManager          │
└─────────────────────────────────────┘
    ↓
启动策略管理器
    ↓
开始交易
```

### 2. 许可证验证流程

```
插件初始化
    ↓
调用 plugin.Validate(licenseKey)
    ↓
┌─────────────────────────────────────┐
│ LicenseValidator.ValidatePlugin:    │
│   1. 解析许可证 (Base64 → JSON)      │
│   2. 检查插件名称                    │
│   3. 检查过期时间                    │
│   4. 验证签名 (SHA-256)              │
│   5. 检查机器ID (如有)               │
│   6. 存储到 LicenseStore             │
└─────────────────────────────────────┘
    ↓
验证成功 → 继续初始化
    ↓
验证失败 → 返回错误，停止加载
```

### 3. 策略执行流程

```
价格变化事件
    ↓
StrategyManager.OnPriceChange(price)
    ↓
遍历所有已注册的策略
    ↓
┌─────────────────────────────────────┐
│ 对每个启用的策略:                    │
│   1. 检查是否启用                    │
│   2. 调用 strategy.OnPriceChange()   │
│   3. 策略生成交易信号                │
│   4. 通过 OrderExecutor 下单         │
└─────────────────────────────────────┘
    ↓
订单成交事件
    ↓
StrategyManager.OnOrderUpdate(update)
    ↓
通知相关策略更新状态
```

## 🔌 插件接口设计

### 核心接口层次

```
Plugin (基础接口)
  ├── GetMetadata() - 获取插件信息
  ├── Initialize()  - 初始化插件
  ├── Validate()    - 验证许可证
  └── Close()       - 关闭插件

StrategyPlugin (策略插件)
  ├── Plugin (继承)
  └── GetStrategy() - 获取策略实例
      ↓
      Strategy (策略接口)
        ├── Name()
        ├── Initialize()
        ├── OnPriceChange()
        ├── OnOrderUpdate()
        ├── GetPositions()
        ├── GetOrders()
        ├── GetStatistics()
        ├── Start()
        └── Stop()

AIPlugin (AI插件)
  ├── Plugin (继承)
  └── Analyze() - 分析市场

SignalPlugin (信号插件)
  ├── Plugin (继承)
  └── GetSignal() - 获取交易信号
```

## 🗂️ 代码组织

### 文件结构

```
quantmesh_market_maker/
├── main.go                      # 主程序入口
├── config.yaml                  # 配置文件
│
├── plugin/                      # 插件系统 (开源)
│   ├── plugin.go               # 插件框架
│   ├── license.go              # 许可证系统
│   ├── README.md               # 文档
│   ├── examples/               # 示例
│   │   ├── demo.go            # 演示程序
│   │   └── example_strategy_plugin.go
│   └── tools/                  # 工具
│       ├── license_generator.go
│       └── license_validator.go
│
├── plugins/                     # 免费插件目录 (开源)
│   ├── example_strategy/
│   ├── trend_following/
│   └── signal_source/
│
├── strategy/                    # 策略框架 (开源)
│   ├── strategy.go             # 策略接口
│   ├── strategy_manager.go     # 策略管理器
│   └── capital_allocator.go    # 资金分配
│
├── exchange/                    # 交易所层 (开源)
├── monitor/                     # 监控系统 (开源)
├── order/                       # 订单执行 (开源)
└── position/                    # 仓位管理 (开源)

# 商业插件 (独立仓库，闭源)
quantmesh-plugin-premium-ai/     # GitHub Private
├── plugin.go                    # 插件实现
├── strategy.go                  # 策略实现
├── ai_engine.go                 # AI引擎
├── optimizer.go                 # 优化器
└── go.mod                       # 依赖配置
```

## 🔐 安全架构

### 多层防护

```
┌─────────────────────────────────────────────────────────────┐
│ 第1层: 访问控制                                              │
│  - GitHub 私有仓库                                           │
│  - 只有付费客户可以访问                                      │
│  - 可以随时撤销访问权限                                      │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ 第2层: 许可证验证                                            │
│  - 启动时验证                                                │
│  - 定期重新验证                                              │
│  - 签名校验防篡改                                            │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ 第3层: 代码混淆                                              │
│  - garble 混淆编译                                           │
│  - 去除调试信息                                              │
│  - 增加逆向难度                                              │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ 第4层: 在线验证 (可选)                                       │
│  - 实时验证许可证                                            │
│  - 远程撤销能力                                              │
│  - 使用统计和监控                                            │
└─────────────────────────────────────────────────────────────┘
```

### 许可证加密

```
原始许可证信息 (JSON)
    ↓
Base64 编码
    ↓
SHA-256 签名
    ↓
许可证密钥 (字符串)
    ↓
AES-256-GCM 加密
    ↓
存储到本地文件 (~/.quantmesh/licenses.enc)
```

## 🔄 版本管理

### 语义化版本

```
v1.0.0 - 初始版本
  ├── v1.0.1 - Bug修复
  ├── v1.0.2 - Bug修复
  └── v1.1.0 - 新功能
      ├── v1.1.1 - Bug修复
      └── v1.2.0 - 新功能
          └── v2.0.0 - 重大更新
```

### 兼容性

```
主程序版本: v3.3.1
    ↓
插件 API 版本: v1.0.0
    ↓
┌─────────────────────────────────────┐
│ 插件版本兼容性:                      │
│  - v1.x.x 插件兼容 v3.x.x 主程序     │
│  - v2.x.x 插件需要 v4.x.x 主程序     │
└─────────────────────────────────────┘
```

## 📊 性能考虑

### 插件加载性能

```
编译时链接:
  - 加载时间: 0ms (已编译到二进制)
  - 内存开销: 最小
  - 性能: 原生性能
  - 推荐: ✅

Go Plugin (.so):
  - 加载时间: ~100ms
  - 内存开销: 中等
  - 性能: 接近原生
  - 推荐: ⚠️ (兼容性问题)

gRPC:
  - 加载时间: ~200ms
  - 内存开销: 高 (独立进程)
  - 性能: 有网络开销
  - 推荐: ❌ (除非需要进程隔离)
```

### 许可证验证性能

```
本地验证:
  - 首次验证: ~1ms
  - 缓存后: ~0.01ms
  - 推荐: ✅

在线验证:
  - 首次验证: ~100-500ms (网络延迟)
  - 缓存后: ~0.01ms
  - 推荐: ⚠️ (可选，用于关键场景)
```

## 🎯 设计原则

### 1. 开放封闭原则
- 对扩展开放: 易于添加新插件
- 对修改封闭: 核心框架稳定

### 2. 依赖倒置原则
- 主程序依赖插件接口
- 插件实现接口
- 解耦合，易测试

### 3. 单一职责原则
- Plugin: 插件管理
- License: 许可证验证
- Strategy: 策略执行
- 各司其职

### 4. 接口隔离原则
- 最小接口设计
- 插件只需实现必要方法
- 降低实现难度

## 🚀 扩展性

### 未来可以添加的插件类型

```
1. 数据源插件
   - 自定义K线数据源
   - 另类数据接入

2. 通知插件
   - 自定义通知渠道
   - 告警规则

3. 回测插件
   - 自定义回测引擎
   - 性能分析

4. 可视化插件
   - 自定义图表
   - 实时监控面板

5. 风控插件
   - 自定义风控规则
   - 合规检查
```

## 📝 总结

这个插件系统架构:

✅ **模块化**: 清晰的分层和接口设计
✅ **安全**: 多层防护机制
✅ **灵活**: 支持多种插件类型
✅ **高性能**: 编译时链接，零开销
✅ **易用**: 完善的工具和文档
✅ **可扩展**: 易于添加新功能

适合用于:
- 量化交易系统
- 策略平台
- 金融软件
- 需要插件化的 Go 应用

