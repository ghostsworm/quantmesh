name: CD

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  GO_VERSION: '1.25.4'

jobs:
  # 创建 Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Get version
      id: get_version
      run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
    - name: Generate changelog
      id: changelog
      uses: metcalfc/changelog-generator@v4.3.1
      with:
        myToken: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ steps.get_version.outputs.version }}
        body: |
          ## What's Changed
          ${{ steps.changelog.outputs.changelog }}
          
          ## Installation
          
          ### Linux (amd64)
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/quantmesh-linux-amd64
          chmod +x quantmesh-linux-amd64
          sudo mv quantmesh-linux-amd64 /usr/local/bin/quantmesh
          ```
          
          ### macOS (arm64)
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/quantmesh-darwin-arm64
          chmod +x quantmesh-darwin-arm64
          sudo mv quantmesh-darwin-arm64 /usr/local/bin/quantmesh
          ```
          
          ### Docker
          ```bash
          docker pull quantmesh/market-maker:${{ steps.get_version.outputs.version }}
          ```
        draft: false
        prerelease: false
        
  # 构建并上传 Release 资产
  build-release:
    name: Build Release Assets
    runs-on: ${{ matrix.os }}
    needs: release
    if: startsWith(github.ref, 'refs/tags/v')
    
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
          - os: macos-latest
            goos: darwin
            goarch: arm64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        
    - name: Build frontend (for go:embed)
      run: |
        mkdir -p web/dist
        if [ -d "webui" ]; then
          cd webui
          if [ -f "package.json" ]; then
            npm ci || npm install
            npm run build
            cd ..
            if [ -d "webui/dist" ] && [ "$(ls -A webui/dist 2>/dev/null)" ]; then
              cp -r webui/dist/* web/dist/ || true
            fi
          else
            cd ..
          fi
        fi
        # 确保 dist 目录至少有一个文件，避免 go:embed 报错
        if [ ! "$(ls -A web/dist 2>/dev/null)" ]; then
          echo "# Placeholder" > web/dist/.gitkeep
        fi
        
    - name: Build
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        VERSION=${{ needs.release.outputs.version }}
        go build -ldflags="-s -w -X main.Version=${VERSION}" -o quantmesh-${{ matrix.goos }}-${{ matrix.goarch }} .
        
    - name: Create archive
      run: |
        VERSION=${{ needs.release.outputs.version }}
        tar -czf quantmesh-${VERSION}-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz \
          quantmesh-${{ matrix.goos }}-${{ matrix.goarch }} \
          config.example.yaml \
          README.md \
          LICENSE
        
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.release.outputs.upload_url }}
        asset_path: ./quantmesh-${{ needs.release.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz
        asset_name: quantmesh-${{ needs.release.outputs.version }}-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz
        asset_content_type: application/gzip
        
  # 部署到 Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [release, build-release]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.quantmesh.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to staging server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        script: |
          cd /opt/quantmesh
          
          # 备份当前版本
          sudo ./scripts/backup.sh
          
          # 停止服务
          sudo systemctl stop quantmesh
          
          # 下载新版本
          wget https://github.com/${{ github.repository }}/releases/latest/download/quantmesh-linux-amd64
          
          # 替换二进制文件
          sudo mv quantmesh-linux-amd64 quantmesh
          sudo chmod +x quantmesh
          
          # 启动服务
          sudo systemctl start quantmesh
          
          # 等待服务启动
          sleep 5
          
          # 健康检查
          curl -f http://localhost:28888/api/status || exit 1
          
    - name: Notify deployment
      if: success()
      run: |
        echo "Staging deployment successful"
        # 可以添加 Slack/Telegram 通知
        
  # 部署到 Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [release, build-release]
    if: |
      (startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://quantmesh.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to production server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        script: |
          cd /opt/quantmesh
          
          # 备份当前版本
          sudo ./scripts/backup.sh
          
          # 停止服务
          sudo systemctl stop quantmesh
          
          # 下载新版本
          wget https://github.com/${{ github.repository }}/releases/latest/download/quantmesh-linux-amd64
          
          # 替换二进制文件
          sudo mv quantmesh-linux-amd64 quantmesh
          sudo chmod +x quantmesh
          
          # 启动服务
          sudo systemctl start quantmesh
          
          # 等待服务启动
          sleep 10
          
          # 健康检查
          curl -f http://localhost:28888/api/status || exit 1
          
    - name: Smoke tests
      run: |
        # 运行冒烟测试
        echo "Running smoke tests..."
        # curl https://quantmesh.com/api/status
        
    - name: Notify deployment
      if: success()
      run: |
        echo "Production deployment successful"
        # 可以添加 Slack/Telegram 通知
        
    - name: Rollback on failure
      if: failure()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        script: |
          cd /opt/quantmesh
          
          # 停止服务
          sudo systemctl stop quantmesh
          
          # 恢复备份
          sudo ./scripts/restore.sh $(ls -t backups/*.tar.gz | head -n 1)
          
          # 启动服务
          sudo systemctl start quantmesh

