# 风控系统介绍

> **版本**: v3.3.2  
> **更新时间**: 2025-01-27

---

## 目录

1. [风控系统概述](#风控系统概述)
2. [多层风控机制](#多层风控机制)
3. [主动风控详解](#主动风控详解)
4. [资金安全检查](#资金安全检查)
5. [对账机制](#对账机制)
6. [订单清理](#订单清理)
7. [风控配置](#风控配置)

---

## 风控系统概述

QuantMesh 采用**多层风控机制**，全方位保障资金安全和交易稳定。

### 风控层次

```
┌─────────────────────────────────────┐
│  第1层：启动前安全检查              │
│  - 余额充足性检查                    │
│  - 杠杆倍数限制                      │
│  - 最大持仓数计算                    │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  第2层：主动风控监控                │
│  - K线成交量异常检测                 │
│  - 多币种联动监控                    │
│  - 自动暂停交易                      │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  第3层：订单清理                    │
│  - 未完成订单数量限制                │
│  - 定期清理旧订单                    │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  第4层：持仓对账                    │
│  - 本地 vs 交易所对账                │
│  - 槽位状态修复                      │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│  第5层：人工干预                    │
│  - 优雅退出                          │
│  - 紧急停止                          │
└─────────────────────────────────────┘
```

---

## 多层风控机制

### 第1层：启动前安全检查

**目的：** 在系统启动前验证账户状态，防止资金不足导致的问题。

**检查内容：**

1. **账户余额充足性**
   - 验证账户余额是否足够
   - 计算最大可用保证金

2. **杠杆倍数限制**
   - 检查杠杆倍数是否超过限制（默认最高 10 倍）
   - 防止过度杠杆

3. **最大可持仓数计算**
   ```
   最大可用保证金 = 账户余额 × 杠杆倍数
   每仓成本 = 订单金额（固定）
   最大持仓数 = 最大可用保证金 / 每仓成本
   ```

4. **手续费率验证**
   - 验证手续费率配置
   - 检查盈利率 vs 手续费率

5. **持仓安全性验证**
   - 验证是否可以安全持有至少 N 仓（默认 100 仓）
   - 确保有足够缓冲应对价格波动

**检查失败处理：**

如果检查失败，系统会：
- ❌ 拒绝启动
- 📝 输出详细的错误信息
- 💡 提供解决建议

**配置示例：**

```yaml
trading:
  position_safety_check: 100  # 最少能向下持有多少仓
```

---

### 第2层：主动风控监控

**目的：** 实时监控市场异常，自动暂停交易，防止极端市场造成的损失。

**监控逻辑：**

1. **实时监听多个主流币种的K线**
   - 默认监控：BTC、ETH、SOL、XRP、DOGE
   - 可配置监控币种列表

2. **计算成交量移动平均**
   ```
   移动平均成交量 = (最近 N 根K线成交量之和) / N
   ```

3. **检测成交量异常**
   ```
   触发条件：当前成交量 > 移动平均成交量 × 倍数阈值
   ```

4. **触发风控**
   - 撤销所有买单
   - 暂停新订单下单
   - 记录风控触发日志

5. **恢复条件**
   ```
   恢复条件：至少 N 个币种恢复正常
   （当前价格 > 移动均价 且 成交量 < 均值×倍数）
   ```

**配置示例：**

```yaml
risk_control:
  enabled: true               # 是否启用风控
  monitor_symbols:            # 监控的主流币种
    - "BTCUSDT"
    - "ETHUSDT"
    - "SOLUSDT"
    - "XRPUSDT"
    - "DOGEUSDT"
  interval: "1m"              # K线周期：1m / 3m / 5m
  volume_multiplier: 3.0      # 成交量倍数：当前量 > 均值×3倍视为异常
  average_window: 20          # 移动平均窗口：20根K线
  recovery_threshold: 3       # 恢复交易所需的正常币种数量
```

**风控触发示例：**

```
[WARN] 🚨 市场异常检测：BTCUSDT 成交量异常（当前: 1000, 平均: 200, 倍数: 5.0）
[WARN] 🚨 市场异常检测：ETHUSDT 成交量异常（当前: 800, 平均: 250, 倍数: 3.2）
[WARN] 🛡️ 主动风控已触发，暂停交易
[INFO] 🔄 正在撤销所有买单...
[INFO] ✅ 已撤销 15 个买单
[INFO] ⏸️ 交易已暂停，等待市场恢复
```

**恢复示例：**

```
[INFO] 📊 市场恢复检查：3/5 个币种已恢复正常
[INFO] ✅ 市场已恢复，恢复交易
[INFO] 🔄 重新开始下单...
```

---

### 第3层：订单清理

**目的：** 防止订单堆积，释放槽位资源。

**清理策略：**

1. **检查未完成订单数量**
   - 定期检查（默认每 60 秒）
   - 统计未完成订单总数

2. **触发清理**
   ```
   触发条件：未完成订单数 > 清理阈值（默认 100）
   ```

3. **批量撤销最旧的订单**
   - 每次清理 N 个订单（默认 10 个/批）
   - 优先清理最旧的订单

4. **重置槽位状态**
   - 将被清理订单对应的槽位重置为 FREE
   - 允许重新下单

**配置示例：**

```yaml
trading:
  order_cleanup_threshold: 100      # 订单清理上限
  cleanup_batch_size: 20            # 清理批次大小
```

**清理示例：**

```
[WARN] ⚠️ 未完成订单数量过多：120 个（阈值：100）
[INFO] 🔄 开始清理订单，批次大小：20
[INFO] ✅ 已撤销 20 个最旧订单
[INFO] 🔄 重置对应槽位状态
```

---

### 第4层：持仓对账

**目的：** 定期同步本地状态与交易所状态，确保数据一致性。

**对账内容：**

1. **持仓对账**
   - 交易所持仓 vs 本地持仓
   - 发现差异并修复

2. **订单对账**
   - 交易所未完成订单 vs 本地订单
   - 发现差异并修复

3. **槽位状态修复**
   - 根据交易所实际状态修复槽位
   - 确保槽位状态正确

**对账周期：**

- 默认每 5 分钟（可配置）
- 风控触发时暂停对账日志（避免日志过多）

**配置示例：**

```yaml
trading:
  reconcile_interval: 60  # 对账间隔（秒）
```

**对账示例：**

```
[INFO] 🔄 开始持仓对账...
[INFO] 📊 本地持仓：10.5 ETH
[INFO] 📊 交易所持仓：10.5 ETH
[INFO] ✅ 持仓一致
[INFO] 📊 本地未完成订单：15 个
[INFO] 📊 交易所未完成订单：15 个
[INFO] ✅ 订单一致
[INFO] ✅ 对账完成
```

---

### 第5层：人工干预

**目的：** 提供人工干预机制，应对紧急情况。

**干预方式：**

1. **优雅退出**
   - 按 `Ctrl+C` 发送 SIGINT 信号
   - 系统会：
     - 撤销所有未完成订单（如果 `cancel_on_exit: true`）
     - 平掉所有持仓（如果 `close_positions_on_exit: true`）
     - 停止所有协程
     - 保存数据
     - 关闭连接

2. **紧急停止**
   - 直接终止进程
   - 或使用 `kill -9` 强制终止

**配置示例：**

```yaml
system:
  cancel_on_exit: true           # 退出时撤销所有订单
  close_positions_on_exit: false # 退出时是否平仓（默认关闭）
```

---

## 主动风控详解

### 工作原理

主动风控通过监控多个主流币种的 K 线成交量，检测市场异常。

**监控流程：**

```
1. 启动 K 线流
   ↓
2. 接收 K 线数据
   ↓
3. 更新 K 线缓存（保留最近 N 根）
   ↓
4. 计算移动平均成交量
   ↓
5. 检测当前成交量是否异常
   ↓
6. 触发风控或恢复正常
```

### 触发条件

**触发风控：**

```
当前成交量 > 移动平均成交量 × volume_multiplier
```

**恢复交易：**

```
至少 recovery_threshold 个币种满足：
- 当前价格 > 移动均价
- 当前成交量 < 移动平均成交量 × volume_multiplier
```

### 配置建议

**保守配置（更敏感）：**

```yaml
risk_control:
  volume_multiplier: 2.0      # 2倍即触发
  average_window: 10           # 使用最近10根K线
  recovery_threshold: 4        # 需要4个币种恢复
```

**激进配置（更宽松）：**

```yaml
risk_control:
  volume_multiplier: 5.0      # 5倍才触发
  average_window: 30           # 使用最近30根K线
  recovery_threshold: 2        # 只需2个币种恢复
```

**默认配置（推荐）：**

```yaml
risk_control:
  volume_multiplier: 3.0      # 3倍触发
  average_window: 20           # 使用最近20根K线
  recovery_threshold: 3        # 需要3个币种恢复
```

---

## 资金安全检查

### 检查内容

启动前会进行以下检查：

1. **账户余额检查**
   ```go
   所需保证金 = order_quantity × (buy_window_size + sell_window_size) × 杠杆倍数
   
   如果 账户余额 < 所需保证金 × 安全系数：
       拒绝启动
   ```

2. **杠杆倍数检查**
   ```go
   如果 杠杆倍数 > max_leverage（默认10）：
       拒绝启动
   ```

3. **最大持仓数计算**
   ```go
   最大可用保证金 = 账户余额 × 杠杆倍数
   每仓成本 = order_quantity
   最大持仓数 = 最大可用保证金 / 每仓成本
   
   如果 最大持仓数 < position_safety_check（默认100）：
       拒绝启动
   ```

### 检查失败处理

如果检查失败，系统会输出详细错误信息：

```
[ERROR] ❌ 持仓安全性检查失败
[ERROR] 💰 账户余额: 1000.00 USDT
[ERROR] 📈 当前币价: 42156.78, 每笔金额: 30.00 USDT
[ERROR] ⚠️ 最多只能持有 33 仓，但要求至少 100 仓
[ERROR] 💡 建议：
[ERROR]    1. 增加账户余额
[ERROR]    2. 降低 order_quantity
[ERROR]    3. 降低 buy_window_size 和 sell_window_size
[ERROR]    4. 降低 position_safety_check 参数
```

---

## 对账机制

### 对账流程

```
1. 获取交易所持仓
   ↓
2. 获取本地持仓
   ↓
3. 对比差异
   ↓
4. 修复不一致
   ↓
5. 获取交易所未完成订单
   ↓
6. 获取本地未完成订单
   ↓
7. 对比差异
   ↓
8. 修复不一致
```

### 对账内容

**持仓对账：**

- 交易所持仓数量
- 本地持仓数量
- 差异修复

**订单对账：**

- 交易所未完成订单列表
- 本地未完成订单列表
- 差异修复

**槽位状态修复：**

- 根据交易所实际状态修复槽位
- 确保槽位状态正确

---

## 订单清理

### 清理策略

**触发条件：**

```
未完成订单数 > order_cleanup_threshold
```

**清理方式：**

1. 按订单创建时间排序
2. 选择最旧的 N 个订单（`cleanup_batch_size`）
3. 批量撤销这些订单
4. 重置对应槽位状态

**清理频率：**

- 默认每 60 秒检查一次
- 如果触发清理，立即执行

---

## 风控配置

### 完整配置示例

```yaml
# 主动安全风控配置
risk_control:
  enabled: true               # 是否启用风控（强烈建议启用）
  
  # 监控的主流币种（用于判断市场整体情绪）
  monitor_symbols:
    - "BTCUSDT"
    - "ETHUSDT"
    - "SOLUSDT"
    - "XRPUSDT"
    - "DOGEUSDT"
  
  interval: "1m"              # K线周期：1m / 3m / 5m
  volume_multiplier: 3.0      # 成交量倍数：当前量 > 均值×3倍视为异常
  average_window: 20          # 移动平均窗口：20根K线
  recovery_threshold: 3       # 恢复交易所需的正常币种数量
  max_leverage: 10            # 最大允许杠杆倍数（默认10，0表示不限制）

# 交易配置中的风控相关参数
trading:
  position_safety_check: 100        # 持仓安全性检查（最少能向下持有多少仓）
  order_cleanup_threshold: 100      # 订单清理上限
  cleanup_batch_size: 20            # 清理批次大小
  reconcile_interval: 60            # 对账间隔（秒）

# 系统配置
system:
  cancel_on_exit: true              # 退出时撤销所有订单
  close_positions_on_exit: false    # 退出时是否平仓（默认关闭）
```

### 配置建议

**首次使用：**

```yaml
risk_control:
  enabled: true
  volume_multiplier: 2.0      # 更敏感，更早触发
  recovery_threshold: 4        # 更严格，需要更多币种恢复
```

**稳定运行后：**

```yaml
risk_control:
  enabled: true
  volume_multiplier: 3.0      # 默认值
  recovery_threshold: 3        # 默认值
```

**高风险市场：**

```yaml
risk_control:
  enabled: true
  volume_multiplier: 2.0      # 更敏感
  recovery_threshold: 4        # 更严格
  monitor_symbols:             # 增加监控币种
    - "BTCUSDT"
    - "ETHUSDT"
    - "SOLUSDT"
    - "XRPUSDT"
    - "DOGEUSDT"
    - "ADAUSDT"
    - "DOTUSDT"
```

---

## 最佳实践

### 1. 必须启用风控

```yaml
risk_control:
  enabled: true  # 必须启用
```

### 2. 合理设置参数

- 根据市场情况调整 `volume_multiplier`
- 根据需求设置 `recovery_threshold`
- 定期检查风控触发情况

### 3. 监控风控状态

- 定期查看日志
- 关注风控触发情况
- 分析触发原因

### 4. 资金管理

- 不要投入全部资金
- 保留足够的保证金缓冲
- 设置合理的 `position_safety_check`

---

## 下一步

- 💡 [使用场景与案例](./06-使用场景.md) - 查看实际应用场景
- ❓ [常见问题 FAQ](./07-常见问题.md) - 解答常见疑问

---

*风控系统是保障资金安全的重要机制，强烈建议启用并合理配置。*

