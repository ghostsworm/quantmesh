# 盈利曲线功能说明

## 功能概述

在对账页面中新增了实际盈利和预期盈利的时间曲线图表展示功能，帮助用户直观地了解策略的盈利表现。

## 主要改动

### 1. 数据库层面

#### 新增字段
在 `reconciliation_history` 表中添加了 `actual_profit` 字段：
- **字段名**: `actual_profit`
- **类型**: `DECIMAL(20,8)`
- **说明**: 记录对账时刻的实际累计盈利（从 trades 表统计）

#### 数据迁移
系统会自动检测并为已存在的表添加 `actual_profit` 字段，无需手动操作。

### 2. 后端改动

#### 新增方法
- `GetActualProfitBySymbol(symbol, beforeTime)`: 计算指定币种在指定时间之前的累计实际盈利
- 修改 `SaveReconciliationHistoryDirect`: 在保存对账历史时自动计算并保存实际盈利

#### API 响应
对账历史 API (`/api/reconciliation/history`) 的响应中新增了 `actual_profit` 字段。

### 3. 前端改动

#### 新增图表
在对账页面顶部添加了盈利趋势图表，展示：
- **蓝色曲线**: 预计盈利（基于价格间隔 × 累计卖出数量计算）
- **绿色曲线**: 实际盈利（从实际成交的交易统计）

#### 表格更新
在对账历史表格中新增"实际盈利"列，方便对比查看。

## 数据说明

### 预计盈利 (Estimated Profit)
- **计算方式**: `累计卖出数量 × 价格间隔`
- **含义**: 理论上的最大盈利，假设所有交易都按照设定的价格间隔完成
- **特点**: 
  - 不考虑手续费
  - 不考虑滑点
  - 不考虑部分成交

### 实际盈利 (Actual Profit)
- **计算方式**: 从 `trades` 表统计所有已完成交易的实际盈亏总和
- **含义**: 真实的盈利情况
- **特点**:
  - 包含实际成交价格
  - 反映真实市场情况
  - 可能因手续费、滑点等因素与预期盈利有差异

## 使用方法

1. **查看图表**
   - 访问对账页面（Reconciliation）
   - 图表会自动展示最近的对账历史数据
   - 蓝色线代表预计盈利，绿色线代表实际盈利

2. **分析差异**
   - 如果实际盈利低于预期盈利，可能的原因：
     - 交易手续费
     - 市场滑点
     - 部分成交导致的价格偏差
   - 如果差异过大，建议检查：
     - 手续费率设置
     - 订单成交情况
     - 市场流动性

3. **查看详细数据**
   - 在下方的对账历史表格中可以看到每次对账的详细数据
   - 包括本地持仓、挂单情况、累计交易量等

## 技术细节

### 图表实现
使用原生 SVG 绘制，无需额外依赖库，具有以下特点：
- 自适应容器大小
- 自动计算坐标轴范围
- 支持多条曲线对比
- 显示数据点和网格线

### 性能优化
- 对账历史数据支持分页查询
- 图表只展示当前页的数据
- 数据按时间排序，最新的在右侧

## 注意事项

1. **数据准确性**
   - 实际盈利数据依赖于 trades 表的记录
   - 确保交易记录完整且准确

2. **时间同步**
   - 对账时间和交易时间需要保持同步
   - 系统会自动处理时区问题

3. **数据更新**
   - 图表数据每 10 秒自动刷新
   - 可以手动刷新页面获取最新数据

## 未来改进方向

1. 增加时间范围筛选功能
2. 支持导出图表数据
3. 添加更多统计指标（如盈利率、夏普比率等）
4. 支持多币种对比
5. 添加图表缩放和拖拽功能

