# å¤šäº¤æ˜“å¯¹è®¢å•è¿‡æ»¤ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

### ç°è±¡
```
2025/12/29 10:37:40 [WARN] âš ï¸ [ä»·æ ¼è§£æå¼‚å¸¸] 
ClientOrderID=x-zdfVM8vY59612_B_1766975844017, 
è§£æä»·æ ¼=596.12, 
é”šç‚¹ä»·æ ¼=2999.88, 
priceDecimals=2, 
å¯èƒ½ priceDecimals å‚æ•°é”™è¯¯
```

### åˆ†æ

1. **ClientOrderID è§£æ**ï¼š
   - æ ¼å¼ï¼š`x-zdfVM8vY59612_B_1766975844017`
   - å»é™¤å¸å®‰å‰ç¼€åï¼š`59612_B_1766975844017`
   - ä»·æ ¼æ•´æ•°éƒ¨åˆ†ï¼š`59612`
   - ä½¿ç”¨ `priceDecimals=2` è§£æï¼š`596.12`

2. **ä»·æ ¼ä¸åŒ¹é…**ï¼š
   - è§£æå‡ºçš„ä»·æ ¼ï¼š`596.12`
   - å½“å‰é”šç‚¹ä»·æ ¼ï¼š`2999.88` (ETHUSDT)
   - æ˜æ˜¾ä¸åŒ¹é…ï¼

3. **æ ¹æœ¬åŸå› **ï¼š
   - ç³»ç»Ÿé…ç½®äº†å¤šä¸ªäº¤æ˜“å¯¹ï¼šETHUSDTã€BCHUSDTã€BTCUSDT
   - BCH çš„ä»·æ ¼èŒƒå›´çº¦ 400-600ï¼Œä¸è§£æå‡ºçš„ `596.12` åŒ¹é…
   - **å¸å®‰çš„ WebSocket è®¢å•æµæ˜¯å…¨å±€çš„**ï¼Œä¼šæ¨é€æ‰€æœ‰äº¤æ˜“å¯¹çš„è®¢å•
   - åŸä»£ç æ²¡æœ‰è¿‡æ»¤ Symbolï¼Œå¯¼è‡´ BCHUSDT çš„è®¢å•è¢« ETHUSDT çš„ç®¡ç†å™¨å¤„ç†

## é—®é¢˜å½±å“

1. **é”™è¯¯çš„æ§½ä½åˆ›å»º**ï¼šä¸åŒäº¤æ˜“å¯¹çš„è®¢å•å¯èƒ½åˆ›å»ºé”™è¯¯ä»·æ ¼çš„æ§½ä½
2. **æŒä»“æ··ä¹±**ï¼šä¸åŒäº¤æ˜“å¯¹çš„æŒä»“å¯èƒ½è¢«é”™è¯¯åœ°åˆå¹¶
3. **è®¢å•ç®¡ç†æ··ä¹±**ï¼šè®¢å•çŠ¶æ€æ›´æ–°å¯èƒ½å½±å“é”™è¯¯çš„æ§½ä½
4. **èµ„é‡‘é£é™©**ï¼šå¯èƒ½å¯¼è‡´æ„å¤–çš„æŒä»“å’Œè®¢å•

## ä¿®å¤æ–¹æ¡ˆ

### 1. è®¢å•æ¨é€è¿‡æ»¤ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰

**æ–‡ä»¶**ï¼š`symbol_manager.go`

**ä¿®æ”¹ä½ç½®**ï¼šè®¢å•æµå›è°ƒå‡½æ•°

**ä¿®å¤å†…å®¹**ï¼š
```go
// è®¢å•æµ
if err := ex.StartOrderStream(ctx, func(updateInterface interface{}) {
    posUpdate := toPositionOrderUpdate(updateInterface)
    if posUpdate == nil {
        return
    }

    // ğŸ”¥ å…³é”®ä¿®å¤ï¼šè¿‡æ»¤æ‰ä¸å±äºå½“å‰äº¤æ˜“å¯¹çš„è®¢å•æ›´æ–°
    // å¸å®‰çš„ WebSocket è®¢å•æµæ˜¯å…¨å±€çš„ï¼Œä¼šæ¨é€æ‰€æœ‰äº¤æ˜“å¯¹çš„è®¢å•
    // å¿…é¡»æ£€æŸ¥ Symbol æ˜¯å¦åŒ¹é…ï¼Œé¿å…ä¸åŒäº¤æ˜“å¯¹çš„è®¢å•äº’ç›¸å¹²æ‰°
    if posUpdate.Symbol != symCfg.Symbol {
        logger.Debug("â­ï¸ [è®¢å•è¿‡æ»¤] è·³è¿‡å…¶ä»–äº¤æ˜“å¯¹çš„è®¢å•: Symbol=%s (å½“å‰äº¤æ˜“å¯¹: %s), ClientOID=%s",
            posUpdate.Symbol, symCfg.Symbol, posUpdate.ClientOrderID)
        return
    }

    // ... åç»­å¤„ç† ...
    superPositionManager.OnOrderUpdate(*posUpdate)
}); err != nil {
    logger.Warn("âš ï¸ [%s] å¯åŠ¨è®¢å•æµå¤±è´¥: %v", symCfg.Symbol, err)
}
```

### 2. ä»·æ ¼è§£æå¼‚å¸¸å¤„ç†ä¼˜åŒ–

**æ–‡ä»¶**ï¼š`position/super_position_manager.go`

**ä¿®æ”¹ä½ç½®**ï¼š`parseClientOrderID` æ–¹æ³•

**ä¼˜åŒ–å†…å®¹**ï¼š
```go
// ğŸ”¥ æ·»åŠ ä»·æ ¼åˆç†æ€§æ£€æŸ¥ï¼šå¦‚æœè§£æå‡ºçš„ä»·æ ¼æ˜æ˜¾å¼‚å¸¸ï¼Œè®°å½•è­¦å‘Š
// å¯èƒ½åŸå› ï¼š
// 1. priceDecimals å‚æ•°é”™è¯¯
// 2. å¤šäº¤æ˜“å¯¹åœºæ™¯ä¸‹ï¼Œè®¢å•å±äºå…¶ä»–äº¤æ˜“å¯¹ï¼ˆåº”è¯¥åœ¨ä¸Šå±‚è¿‡æ»¤ï¼Œä½†è¿™é‡Œä½œä¸ºå…œåº•æ£€æŸ¥ï¼‰
// 3. å†å²é—ç•™è®¢å•ï¼ˆåˆ‡æ¢äº¤æ˜“å¯¹åçš„æ—§è®¢å•ï¼‰
if spm.anchorPrice > 1000 && price < 1000 && price > 0 {
    logger.Warn("âš ï¸ [ä»·æ ¼è§£æå¼‚å¸¸] ClientOrderID=%s, è§£æä»·æ ¼=%.2f, é”šç‚¹ä»·æ ¼=%.2f, priceDecimals=%d",
        clientOrderID, price, spm.anchorPrice, spm.priceDecimals)
    logger.Warn("ğŸ’¡ [å¯èƒ½åŸå› ] 1) æ­¤è®¢å•å±äºå…¶ä»–äº¤æ˜“å¯¹ 2) priceDecimals å‚æ•°é”™è¯¯ 3) å†å²é—ç•™è®¢å•")
    logger.Warn("ğŸ’¡ [å»ºè®®] æ£€æŸ¥æ˜¯å¦è¿è¡Œäº†å¤šä¸ªäº¤æ˜“å¯¹ï¼Œç¡®ä¿è®¢å•æ¨é€å·²æ­£ç¡®è¿‡æ»¤ Symbol")
    
    // å°è¯•ä½¿ç”¨ä¸åŒçš„ priceDecimals é‡æ–°è§£æï¼ˆç”¨äºè¯Šæ–­ï¼‰
    for testDecimals := 1; testDecimals <= 3; testDecimals++ {
        if testDecimals == spm.priceDecimals {
            continue
        }
        testPrice, _, _, testValid := utils.ParseOrderID(cleanID, testDecimals)
        if testValid && testPrice > 1000 && math.Abs(testPrice-spm.anchorPrice) < spm.anchorPrice*0.5 {
            logger.Warn("âš ï¸ [ä»·æ ¼è§£æä¿®å¤] ä½¿ç”¨ priceDecimals=%d é‡æ–°è§£æå¾—åˆ°ä»·æ ¼=%.2f", testDecimals, testPrice)
            return testPrice, side, true
        }
    }
    
    // æ— æ³•ä¿®å¤ï¼Œè¿”å›æ— æ•ˆï¼ˆé¿å…åˆ›å»ºé”™è¯¯çš„æ§½ä½ï¼‰
    return 0, "", false
}
```

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ BCHUSDT çš„è®¢å•æ¨é€è¢« ETHUSDT ç®¡ç†å™¨å¤„ç†
- âŒ åˆ›å»ºé”™è¯¯ä»·æ ¼çš„æ§½ä½ï¼ˆ596.12ï¼‰
- âŒ è§¦å‘ä»·æ ¼è§£æå¼‚å¸¸è­¦å‘Š
- âŒ å¯èƒ½å¯¼è‡´æŒä»“å’Œè®¢å•ç®¡ç†æ··ä¹±

### ä¿®å¤å
- âœ… æ¯ä¸ªç®¡ç†å™¨åªå¤„ç†è‡ªå·±äº¤æ˜“å¯¹çš„è®¢å•
- âœ… å…¶ä»–äº¤æ˜“å¯¹çš„è®¢å•è¢«æ­£ç¡®è¿‡æ»¤
- âœ… ä¸å†åˆ›å»ºé”™è¯¯ä»·æ ¼çš„æ§½ä½
- âœ… ä»·æ ¼è§£æå¼‚å¸¸ä½œä¸ºå…œåº•æ£€æŸ¥ï¼Œæä¾›æ›´è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯

## æµ‹è¯•å»ºè®®

1. **é‡å¯ç³»ç»Ÿ**ï¼š
   ```bash
   ./stop.sh
   ./start.sh
   ```

2. **è§‚å¯Ÿæ—¥å¿—**ï¼š
   - åº”è¯¥çœ‹åˆ° `[è®¢å•è¿‡æ»¤]` çš„æ—¥å¿—ï¼Œè¯´æ˜è¿‡æ»¤æ­£åœ¨å·¥ä½œ
   - ä¸åº”è¯¥å†çœ‹åˆ°ä»·æ ¼è§£æå¼‚å¸¸ï¼ˆé™¤éçœŸçš„æœ‰é—®é¢˜ï¼‰

3. **æ£€æŸ¥æ§½ä½**ï¼š
   - è®¿é—® Web UI æŸ¥çœ‹å„äº¤æ˜“å¯¹çš„æ§½ä½
   - ç¡®ä¿æ¯ä¸ªäº¤æ˜“å¯¹çš„æ§½ä½ä»·æ ¼éƒ½åœ¨åˆç†èŒƒå›´å†…

4. **ç›‘æ§è®¢å•**ï¼š
   - è§‚å¯Ÿè®¢å•æˆäº¤åçš„æ§½ä½æ›´æ–°
   - ç¡®ä¿è®¢å•æ›´æ–°åªå½±å“å¯¹åº”äº¤æ˜“å¯¹çš„æ§½ä½

## ç›¸å…³æ–‡ä»¶

- `symbol_manager.go` - è®¢å•æµå›è°ƒå’Œè¿‡æ»¤
- `position/super_position_manager.go` - ä»·æ ¼è§£æå’Œæ§½ä½ç®¡ç†
- `utils/orderid.go` - ClientOrderID ç”Ÿæˆå’Œè§£æ

## æ³¨æ„äº‹é¡¹

1. **å†å²è®¢å•æ¸…ç†**ï¼š
   - å¦‚æœç³»ç»Ÿä¸­æœ‰å†å²é—ç•™çš„é”™è¯¯æ§½ä½ï¼Œå»ºè®®æ¸…ç†åé‡å¯
   - å¯ä»¥ä½¿ç”¨ Web UI æˆ–ç›´æ¥æ¸…ç†æ•°æ®åº“

2. **å…¶ä»–äº¤æ˜“æ‰€**ï¼š
   - æ­¤ä¿®å¤ä¸»è¦é’ˆå¯¹å¸å®‰
   - å…¶ä»–äº¤æ˜“æ‰€ï¼ˆBitgetã€Gate.io ç­‰ï¼‰ä¹Ÿåº”è¯¥æ£€æŸ¥æ˜¯å¦æœ‰ç±»ä¼¼é—®é¢˜
   - å»ºè®®åœ¨æ‰€æœ‰äº¤æ˜“æ‰€çš„è®¢å•æµå›è°ƒä¸­éƒ½æ·»åŠ  Symbol è¿‡æ»¤

3. **ç›‘æ§å»ºè®®**ï¼š
   - å®šæœŸæ£€æŸ¥æ—¥å¿—ä¸­çš„ `[è®¢å•è¿‡æ»¤]` æ¶ˆæ¯
   - å¦‚æœæŸä¸ªäº¤æ˜“å¯¹çš„è®¢å•è¢«é¢‘ç¹è¿‡æ»¤ï¼Œå¯èƒ½è¯´æ˜é…ç½®æœ‰é—®é¢˜

## æ€»ç»“

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**å¤šäº¤æ˜“å¯¹éš”ç¦»é—®é¢˜**ã€‚åœ¨å¤šäº¤æ˜“å¯¹åœºæ™¯ä¸‹ï¼Œå¿…é¡»ç¡®ä¿ï¼š

1. âœ… **è®¢å•æ¨é€è¿‡æ»¤**ï¼šæ¯ä¸ªç®¡ç†å™¨åªå¤„ç†è‡ªå·±äº¤æ˜“å¯¹çš„è®¢å•
2. âœ… **æ§½ä½éš”ç¦»**ï¼šä¸åŒäº¤æ˜“å¯¹çš„æ§½ä½å®Œå…¨ç‹¬ç«‹
3. âœ… **æŒä»“éš”ç¦»**ï¼šä¸åŒäº¤æ˜“å¯¹çš„æŒä»“ä¸èƒ½æ··æ·†
4. âœ… **å¼‚å¸¸æ£€æµ‹**ï¼šåŠæ—¶å‘ç°å’ŒæŠ¥å‘Šè·¨äº¤æ˜“å¯¹çš„å¼‚å¸¸

æ­¤æ¬¡ä¿®å¤é€šè¿‡åœ¨è®¢å•æµå›è°ƒä¸­æ·»åŠ  Symbol è¿‡æ»¤ï¼Œä»æ ¹æºä¸Šè§£å†³äº†é—®é¢˜ã€‚

