# QuantMesh Market Maker 部署指南

## 概述

本指南介绍如何将 QuantMesh Market Maker 部署到生产环境，包括在线编译、数据库保护和服务管理。

## 目录

- [部署方式选择](#部署方式选择)
- [在线编译部署（推荐）](#在线编译部署推荐)
- [Mac 本地编译限制](#mac-本地编译限制)
- [数据库保护](#数据库保护)
- [服务管理](#服务管理)
- [常见问题](#常见问题)

---

## 部署方式选择

### 推荐方案：在线编译

**优点：**
- ✅ 避免跨平台编译问题（特别是 CGO + SQLite）
- ✅ 编译环境与运行环境一致，减少兼容性问题
- ✅ 不需要在本地安装交叉编译工具链
- ✅ 更简单、更可靠

**适用场景：**
- 服务器已安装 Go 环境
- 服务器架构与编译环境一致（通常是 Linux amd64）

### 备选方案：本地编译后上传

**优点：**
- ✅ 不占用服务器编译资源
- ✅ 可以提前验证编译结果

**缺点：**
- ❌ Mac 上交叉编译 CGO 程序到 Linux amd64 比较复杂
- ❌ 需要安装交叉编译工具链
- ❌ 可能遇到兼容性问题

---

## 在线编译部署（推荐）

### 前置要求

1. **服务器环境：**
   - Linux 系统（推荐 Ubuntu 20.04+ 或 CentOS 7+）
   - Go 1.18+ 已安装
   - Node.js 16+ 和 yarn/npm（用于前端构建）
   - Git（用于拉取代码）

2. **数据库保护：**
   - 确保 `data/` 目录存在且不会被覆盖
   - 数据库文件路径：
     - `./data/quantmesh.db` - 主数据库
     - `./logs.db` - 日志数据库
     - `./data/auth.db` - 认证数据库
     - `./data/webauthn.db` - WebAuthn 数据库

### 部署步骤

#### 1. 准备服务器环境

```bash
# 安装 Go（如果未安装）
# Ubuntu/Debian
sudo apt update
sudo apt install -y golang-go

# CentOS/RHEL
sudo yum install -y golang

# 验证 Go 版本
go version

# 安装 Node.js 和 yarn（如果未安装）
# 使用 nvm 安装 Node.js
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18

# 安装 yarn
npm install -g yarn
```

#### 2. 拉取代码

```bash
# 如果使用 Git
cd /path/to/deployment
git pull origin main

# 或者直接上传代码到服务器
```

#### 3. 使用部署脚本

```bash
# 给脚本添加执行权限
chmod +x deploy.sh

# 执行部署（自动编译、备份、重启）
./deploy.sh

# 或者指定目标路径
./deploy.sh --target /usr/local/bin/quantmesh

# 跳过编译（如果已经编译过）
./deploy.sh --skip-build

# 跳过备份（不推荐）
./deploy.sh --skip-backup
```

#### 4. 手动部署（不使用脚本）

```bash
# 1. 备份数据库
mkdir -p backups
cp -r data backups/data_$(date +%Y%m%d_%H%M%S)
cp logs.db backups/logs.db_$(date +%Y%m%d_%H%M%S)

# 2. 停止服务
sudo systemctl stop quantmesh
# 或
supervisorctl stop quantmesh

# 3. 构建前端
cd webui
yarn install
yarn build
cd ..
cp -r webui/dist web/dist

# 4. 构建后端
export CGO_ENABLED=1
go build -o quantmesh .

# 5. 重启服务
sudo systemctl start quantmesh
# 或
supervisorctl start quantmesh
```

---

## Mac 本地编译限制

### 问题说明

**Mac（特别是 Apple Silicon）无法直接编译出 Linux amd64 的 CGO 程序。**

原因：
1. SQLite 需要 CGO 支持
2. CGO 交叉编译需要目标平台的 C 编译器
3. Mac 默认没有 Linux 的 C 编译器

### 解决方案

#### 方案 1：使用 Docker 编译（推荐）

```bash
# 使用 Docker 在 Linux 环境中编译
docker run --rm -v "$PWD":/app -w /app golang:1.21 \
  bash -c "export CGO_ENABLED=1 && go build -o quantmesh ."
```

#### 方案 2：安装交叉编译工具链（复杂）

```bash
# 安装 musl-cross（用于静态链接）
brew install musl-cross

# 设置环境变量
export CC=x86_64-linux-musl-gcc
export CGO_ENABLED=1
export GOOS=linux
export GOARCH=amd64

# 编译
go build -o quantmesh-linux-amd64 .
```

**注意：** 这种方法可能遇到 SQLite 依赖问题，不推荐。

#### 方案 3：在线编译（最简单）

直接在服务器上编译，避免所有跨平台问题。

---

## 数据库保护

### 数据库文件位置

项目使用多个 SQLite 数据库文件：

```
项目根目录/
├── data/
│   ├── quantmesh.db      # 主数据库（订单、持仓、交易等）
│   ├── auth.db          # 认证数据库
│   └── webauthn.db      # WebAuthn 数据库
├── logs.db              # 日志数据库
└── config.yaml          # 配置文件
```

### 保护措施

#### 1. 部署脚本自动备份

`deploy.sh` 脚本会自动备份所有数据库文件：

```bash
./deploy.sh
# 自动备份到 backups/db_backup_YYYYMMDD_HHMMSS/
```

#### 2. 手动备份

```bash
# 创建备份目录
mkdir -p backups

# 备份所有数据库
cp -r data backups/data_$(date +%Y%m%d_%H%M%S)
cp logs.db backups/logs.db_$(date +%Y%m%d_%H%M%S)
cp config.yaml backups/config.yaml_$(date +%Y%m%d_%H%M%S)
```

#### 3. 部署时不会覆盖数据库

- ✅ 部署脚本只编译和替换二进制文件
- ✅ 不会删除或覆盖 `data/` 目录
- ✅ 不会删除或覆盖 `logs.db`
- ✅ 配置文件需要手动更新（不会自动覆盖）

#### 4. 恢复数据库

```bash
# 从备份恢复
cp backups/db_backup_YYYYMMDD_HHMMSS/quantmesh.db data/quantmesh.db
cp backups/db_backup_YYYYMMDD_HHMMSS/logs.db logs.db
cp backups/db_backup_YYYYMMDD_HHMMSS/config.yaml config.yaml
```

---

## 服务管理

### Systemd 配置

创建 `/etc/systemd/system/quantmesh.service`：

```ini
[Unit]
Description=QuantMesh Market Maker
After=network.target

[Service]
Type=simple
User=your_user
WorkingDirectory=/path/to/quantmesh
ExecStart=/path/to/quantmesh/quantmesh config.yaml
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

# 环境变量（如果需要代理）
Environment="https_proxy=http://127.0.0.1:7890"
Environment="http_proxy=http://127.0.0.1:7890"

[Install]
WantedBy=multi-user.target
```

使用 systemd：

```bash
# 重载配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start quantmesh

# 停止服务
sudo systemctl stop quantmesh

# 重启服务
sudo systemctl restart quantmesh

# 查看状态
sudo systemctl status quantmesh

# 查看日志
sudo journalctl -u quantmesh -f

# 开机自启
sudo systemctl enable quantmesh
```

### Supervisor 配置

创建 `/etc/supervisor/conf.d/quantmesh.conf`：

```ini
[program:quantmesh]
command=/path/to/quantmesh/quantmesh config.yaml
directory=/path/to/quantmesh
user=your_user
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/path/to/quantmesh/logs/supervisor.log
environment=https_proxy="http://127.0.0.1:7890",http_proxy="http://127.0.0.1:7890"
```

使用 supervisor：

```bash
# 重载配置
sudo supervisorctl reread
sudo supervisorctl update

# 启动服务
sudo supervisorctl start quantmesh

# 停止服务
sudo supervisorctl stop quantmesh

# 重启服务
sudo supervisorctl restart quantmesh

# 查看状态
sudo supervisorctl status quantmesh

# 查看日志
sudo supervisorctl tail -f quantmesh
```

---

## 常见问题

### Q1: 编译失败，提示找不到 SQLite

**原因：** 服务器缺少 SQLite 开发库。

**解决方案：**

```bash
# Ubuntu/Debian
sudo apt install -y libsqlite3-dev

# CentOS/RHEL
sudo yum install -y sqlite-devel
```

### Q2: 部署后数据库被覆盖了

**原因：** 手动删除了 `data/` 目录或使用了错误的部署方式。

**解决方案：**
1. 从备份恢复数据库
2. 确保使用 `deploy.sh` 脚本部署（会自动备份）
3. 不要手动删除 `data/` 目录

### Q3: 服务启动失败

**检查步骤：**

1. 检查二进制文件是否存在且可执行：
   ```bash
   ls -lh quantmesh
   chmod +x quantmesh
   ```

2. 检查配置文件是否存在：
   ```bash
   ls -lh config.yaml
   ```

3. 检查日志：
   ```bash
   tail -f logs/quantmesh.log
   # 或
   sudo journalctl -u quantmesh -f
   ```

4. 手动运行测试：
   ```bash
   ./quantmesh config.yaml
   ```

### Q4: Mac 上如何编译 Linux 版本？

**推荐：** 使用在线编译，在服务器上直接编译。

**备选：** 使用 Docker 编译（见上文）。

### Q5: 如何更新配置而不重启服务？

**注意：** 配置文件修改后需要重启服务才能生效。

```bash
# 使用部署脚本（推荐）
./deploy.sh --skip-build

# 或手动重启
sudo systemctl restart quantmesh
# 或
supervisorctl restart quantmesh
```

### Q6: 如何查看实时日志？

```bash
# Systemd
sudo journalctl -u quantmesh -f

# Supervisor
supervisorctl tail -f quantmesh

# 直接查看日志文件
tail -f logs/quantmesh.log
```

---

## 最佳实践

1. **定期备份数据库**
   - 使用 `deploy.sh` 脚本自动备份
   - 或设置定时任务定期备份

2. **使用版本控制**
   - 将代码提交到 Git
   - 在服务器上使用 `git pull` 更新代码

3. **监控服务状态**
   - 使用 systemd 或 supervisor 管理服务
   - 设置告警监控服务状态

4. **测试部署**
   - 先在测试环境验证部署流程
   - 确认数据库备份和恢复流程

5. **文档化配置**
   - 记录服务器配置和部署步骤
   - 保存配置文件模板

---

## 总结

- ✅ **推荐使用在线编译**：简单、可靠、避免跨平台问题
- ✅ **使用部署脚本**：自动备份、保护数据库
- ✅ **使用 systemd 或 supervisor**：管理服务生命周期
- ❌ **避免在 Mac 上交叉编译**：CGO + SQLite 交叉编译复杂且容易出错

如有问题，请查看日志文件或联系技术支持。

