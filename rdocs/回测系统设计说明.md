# 策略回测系统设计说明

## 一、需求概述

对网格策略以及其他策略（趋势跟踪、均值回归等）进行历史数据回测，评估策略的盈利能力、风险指标，优化参数配置。

## 二、数据依赖

### 1. 历史K线数据
- **来源**: 通过 `exchange.IExchange.GetHistoricalKlines()` 获取
- **数据字段**: 
  - 时间戳 (Timestamp)
  - 开盘价 (Open)
  - 最高价 (High)
  - 最低价 (Low)
  - 收盘价 (Close)
  - 成交量 (Volume)
- **周期**: 支持 1m/5m/15m/30m/1h/4h/1d 等
- **数量**: 建议至少 1000 根K线（约16小时-1天的数据，取决于周期）

### 2. 策略配置
- **网格策略参数**:
  - `price_interval`: 价格间隔
  - `order_quantity`: 每单金额
  - `buy_window_size`: 买单窗口大小
  - `sell_window_size`: 卖单窗口大小
- **其他策略参数**: 根据具体策略而定

### 3. 交易环境参数
- **初始资金**: 用于回测的起始资金（USDT）
- **手续费率**: 从配置中读取 `exchanges.{exchange}.fee_rate`（默认 0.02%）
- **滑点模型**: 可选，模拟实际交易的滑点（建议 0.01%-0.05%）
- **杠杆倍数**: 如果使用杠杆，需要配置杠杆倍数（默认 1，即无杠杆）

### 4. 交易所信息
- **交易对**: symbol（如 ETHUSDT）
- **价格精度**: price_decimals
- **数量精度**: quantity_decimals

## 三、实现方案

### 1. 整体架构

```
Backtester（回测器）
├── MockExchange（模拟交易所）
│   ├── 模拟账户余额管理
│   ├── 模拟订单簿
│   └── 模拟订单成交（考虑滑点）
├── MockExecutor（模拟订单执行器）
│   ├── 记录所有订单
│   └── 计算手续费
└── Strategy（策略实例）
    ├── GridStrategy
    ├── TrendFollowingStrategy
    └── MeanReversionStrategy
```

### 2. 核心组件

#### 2.1 MockExchange（模拟交易所）

```go
type MockExchange struct {
    balance        float64      // 账户余额（USDT）
    positions      []*Position  // 持仓列表
    feeRate        float64      // 手续费率
    priceDecimals  int          // 价格精度
    quantityDecimals int        // 数量精度
    
    // 订单簿（用于模拟成交）
    buyOrders      []*Order     // 买单列表
    sellOrders     []*Order     // 卖单列表
}
```

**功能**:
- 模拟下单：将订单添加到订单簿
- 模拟成交：根据K线价格判断订单是否成交
- 计算手续费：按费率扣除手续费
- 更新账户余额和持仓

#### 2.2 MockExecutor（模拟订单执行器）

```go
type MockExecutor struct {
    exchange       *MockExchange
    orders         []*Order      // 所有订单记录
    trades         []*Trade      // 所有成交记录
    orderIDCounter int64         // 订单ID计数器
}
```

**功能**:
- 实现 `OrderExecutorInterface` 接口
- 记录所有订单和成交记录
- 提供订单和成交查询接口

#### 2.3 Backtester（回测器）

```go
type Backtester struct {
    strategy       Strategy           // 策略实例
    historicalData []*exchange.Candle // 历史K线数据
    mockExchange   *MockExchange      // 模拟交易所
    mockExecutor   *MockExecutor      // 模拟执行器
    
    // 回测参数
    initialCapital float64            // 初始资金
    feeRate        float64            // 手续费率
    slippage       float64            // 滑点（可选）
    
    // 回测状态
    equity         []EquityPoint      // 权益曲线（用于计算回撤）
    trades         []*Trade           // 所有交易记录
}
```

### 3. 回测流程

```
1. 初始化
   ├── 创建 MockExchange（初始资金）
   ├── 创建 MockExecutor
   ├── 创建策略实例（使用 MockExecutor）
   └── 初始化策略（Strategy.Initialize）

2. 遍历历史K线
   FOR each candle in historicalData:
     ├── 更新模拟交易所的当前价格（candle.Close）
     ├── 检查订单簿中是否有订单成交
     │   ├── 买单：如果当前价格 <= 订单价格，成交
     │   └── 卖单：如果当前价格 >= 订单价格，成交
     ├── 处理成交订单
     │   ├── 更新账户余额
     │   ├── 扣除手续费
     │   ├── 更新持仓
     │   └── 调用策略的 OnOrderUpdate
     ├── 调用策略的 OnPriceChange(price)
     │   └── 策略可能产生新订单
     └── 记录权益点（用于计算回撤）
         └── equity = balance + positionValue

3. 平仓所有持仓（按最后价格）
   ├── 计算最终余额
   └── 记录最终权益

4. 计算回测指标
   ├── 总盈亏 = 最终余额 - 初始资金
   ├── 总交易次数
   ├── 胜率 = 盈利交易数 / 总交易数
   ├── 最大回撤 = max(peak - current) / peak
   ├── 夏普比率 = (平均收益率 - 无风险利率) / 收益率标准差
   ├── 盈亏比 = 平均盈利 / 平均亏损
   └── 年化收益率（如果有时间跨度）
```

### 4. 关键设计点

#### 4.1 订单成交模拟

**网格策略的订单成交**:
- 买单：当价格下跌到订单价格时成交
- 卖单：当价格上涨到订单价格时成交
- 使用K线的 Close 价格作为成交价（或使用 High/Low 更精确模拟）

**滑点处理**:
```go
// 买单滑点：实际成交价 = 订单价 + 滑点
actualBuyPrice = orderPrice * (1 + slippage)

// 卖单滑点：实际成交价 = 订单价 - 滑点
actualSellPrice = orderPrice * (1 - slippage)
```

#### 4.2 手续费计算

```go
// 开仓手续费（买入）
buyFee = orderAmount * feeRate

// 平仓手续费（卖出）
sellFee = sellAmount * feeRate

// 总手续费
totalFee = buyFee + sellFee
```

#### 4.3 持仓管理

**网格策略的持仓**:
- 网格策略可能有多个持仓（每个网格价格一个）
- 需要分别跟踪每个持仓的买入价和数量
- 计算未实现盈亏时使用当前价格

#### 4.4 权益曲线计算

```go
type EquityPoint struct {
    Time  time.Time
    Equity float64  // 总权益 = 余额 + 持仓价值
}

// 计算当前权益
currentEquity = balance + sum(position.Value)
```

#### 4.5 最大回撤计算

```go
// 计算峰值
peak := initialCapital
maxDrawdown := 0.0

for _, equity := range equityCurve {
    if equity.Equity > peak {
        peak = equity.Equity
    }
    
    drawdown := (peak - equity.Equity) / peak
    if drawdown > maxDrawdown {
        maxDrawdown = drawdown
    }
}
```

#### 4.6 网格策略特殊处理

网格策略使用 `SuperPositionManager` 来管理订单和持仓，回测时需要：

1. **创建模拟的 SuperPositionManager**:
   - 需要模拟的 `OrderExecutorInterface`
   - 需要模拟的 `IExchange`（用于获取价格精度等）

2. **处理订单调整**:
   - 网格策略会在价格变化时调用 `AdjustOrders`
   - 需要模拟订单的取消和重新下单

3. **槽位系统**:
   - 网格策略使用槽位（Slot）来管理每个价格点的订单
   - 回测时需要模拟槽位状态

### 5. 回测结果

```go
type BacktestResult struct {
    // 基本信息
    StartTime      time.Time
    EndTime        time.Time
    Duration       time.Duration
    InitialCapital float64
    FinalCapital   float64
    
    // 收益指标
    TotalPnL       float64  // 总盈亏
    TotalReturn    float64  // 总收益率 (%)
    AnnualReturn   float64  // 年化收益率 (%)
    
    // 交易统计
    TotalTrades    int      // 总交易次数
    WinningTrades  int      // 盈利交易数
    LosingTrades   int      // 亏损交易数
    WinRate        float64  // 胜率 (%)
    
    // 风险指标
    MaxDrawdown    float64  // 最大回撤 (%)
    SharpeRatio    float64  // 夏普比率
    ProfitFactor   float64  // 盈亏比
    AverageWin     float64  // 平均盈利
    AverageLoss    float64  // 平均亏损
    
    // 费用统计
    TotalFee       float64  // 总手续费
    
    // 详细数据
    EquityCurve    []EquityPoint  // 权益曲线
    Trades         []*Trade       // 交易记录
}
```

## 四、实现步骤

### 第一阶段：基础框架
1. 实现 `MockExchange`（模拟交易所）
2. 实现 `MockExecutor`（模拟订单执行器）
3. 实现基础的 `Backtester` 框架

### 第二阶段：回测流程
1. 实现K线遍历和订单成交逻辑
2. 实现权益曲线计算
3. 实现基础的统计指标（总盈亏、交易次数、胜率）

### 第三阶段：高级指标
1. 实现最大回撤计算
2. 实现夏普比率计算
3. 实现其他风险指标

### 第四阶段：网格策略适配
1. 实现模拟的 `SuperPositionManager`
2. 适配网格策略的特殊逻辑
3. 测试和优化

## 五、使用示例

```go
// 1. 创建回测器
backtester := backtest.NewBacktester(
    strategy,           // 策略实例
    historicalData,     // 历史K线数据
    initialCapital,     // 初始资金 10000 USDT
    feeRate,            // 手续费率 0.0002 (0.02%)
)

// 2. 运行回测
result, err := backtester.Run()

// 3. 查看结果
fmt.Printf("总盈亏: %.2f USDT\n", result.TotalPnL)
fmt.Printf("总收益率: %.2f%%\n", result.TotalReturn)
fmt.Printf("最大回撤: %.2f%%\n", result.MaxDrawdown)
fmt.Printf("胜率: %.2f%%\n", result.WinRate)
fmt.Printf("夏普比率: %.2f\n", result.SharpeRatio)
```

## 六、注意事项

1. **数据质量**: 确保历史K线数据完整且准确
2. **滑点模型**: 实际交易会有滑点，回测时建议加入滑点模拟
3. **资金费用**: 如果是永续合约，需要考虑资金费用（当前版本可暂不考虑）
4. **订单深度**: 实际交易可能因为订单深度不足而无法成交，回测时简化处理
5. **网格策略复杂度**: 网格策略涉及槽位管理，回测实现相对复杂
6. **性能**: 大量K线数据回测可能较慢，考虑优化或分批处理

## 七、扩展功能

1. **参数优化**: 支持多参数组合回测，找到最优参数
2. **可视化**: 绘制权益曲线、回撤曲线等图表
3. **对比分析**: 支持多个策略对比回测
4. **报告生成**: 生成详细的回测报告（HTML/PDF）

