# 币安合约账户：可转出金额 vs 保证金余额差异说明

## 问题描述

使用一键平仓功能后，在币安demo账户中观察到：
- **保证金余额（Margin Balance）**: 6,337.58 USDT
- **可转出金额（Available for Transfer）**: 5,388.48 USDT
- **差额**: 约 949.10 USDT

## 原因分析

### 1. 币安合约账户的资金结构

在币安合约交易中，资金分为以下几个概念：

```
钱包余额（Wallet Balance）= 实际存入的资金
未实现盈亏（Unrealized PNL）= 当前持仓的浮动盈亏
保证金余额（Margin Balance）= 钱包余额 + 未实现盈亏
可用余额（Available Balance）= 可以用于开新仓的资金
可转出金额（Available for Transfer）= 可以转出到现货账户的资金
```

### 2. 为什么可转出金额比保证金余额少？

**关键原因：可转出金额不包括未实现盈亏**

在币安合约账户中：
- **保证金余额** = 钱包余额 + 未实现盈亏（包括所有持仓的浮动盈亏）
- **可转出金额** = 钱包余额 - 持仓占用的保证金 - 挂单占用的保证金

**重要区别**：
- ✅ **保证金余额**包含未实现盈亏，这是账户的总权益
- ❌ **可转出金额**不包含未实现盈亏，只能转出实际的钱包余额部分

### 3. 具体场景分析

#### 场景1：平仓后仍有未实现盈亏

即使您使用一键平仓功能平掉了某个交易对的持仓，如果：
- 还有其他交易对的持仓
- 或者平仓订单还未完全成交
- 或者有挂单占用保证金

那么：
- **保证金余额**会包含这些持仓的未实现盈亏
- **可转出金额**只会计算钱包余额中未被占用的部分

#### 场景2：挂单占用保证金

如果您有挂单（买单或卖单），这些订单会占用保证金：
- 买单会占用可用余额作为保证金
- 卖单（平仓单）也会占用部分保证金

这些被占用的资金不能转出，直到订单成交或取消。

#### 场景3：未实现盈亏不能直接转出

未实现盈亏是浮动的，只有在平仓后才会变成已实现盈亏，才能计入钱包余额。因此：
- 未实现盈亏会计入**保证金余额**
- 但不会计入**可转出金额**

### 4. 计算公式

```
保证金余额 = 钱包余额 + 未实现盈亏（所有持仓）

可转出金额 = 钱包余额 - 持仓占用的保证金 - 挂单占用的保证金

差额 = 保证金余额 - 可转出金额
     = 未实现盈亏 + 持仓占用的保证金 + 挂单占用的保证金
```

## 解决方案

### 方案1：等待所有持仓平仓

如果您想转出更多资金：
1. 确保所有持仓都已平仓（包括其他交易对）
2. 取消所有挂单
3. 等待订单完全成交
4. 此时可转出金额应该接近钱包余额

### 方案2：检查其他持仓

检查是否有其他交易对的持仓：
1. 登录币安合约账户
2. 查看"持仓"页面
3. 确认是否还有其他未平仓的持仓

### 方案3：检查挂单

检查是否有挂单占用保证金：
1. 查看"当前委托"页面
2. 取消不需要的挂单
3. 释放被占用的保证金

### 方案4：等待未实现盈亏实现

如果您的持仓有未实现盈亏：
1. 等待持仓平仓
2. 未实现盈亏会变成已实现盈亏
3. 已实现盈亏会计入钱包余额
4. 此时可以转出

## 常见问题

### Q1: 为什么平仓后还有未实现盈亏？

**A**: 可能的原因：
- 还有其他交易对的持仓
- 平仓订单还未完全成交
- 系统延迟更新

### Q2: 未实现盈亏什么时候能转出？

**A**: 未实现盈亏只有在平仓后才会变成已实现盈亏，才能转出。在持仓期间，未实现盈亏不能直接转出。

### Q3: 如何查看被占用的保证金？

**A**: 在币安合约账户中：
- 查看"资产"页面，可以看到每个资产的"可用余额"
- 查看"持仓"页面，可以看到每个持仓占用的保证金
- 查看"当前委托"页面，可以看到挂单占用的保证金

### Q4: 这是正常现象吗？

**A**: 是的，这是**正常现象**。币安合约账户的设计就是这样的：
- 保证金余额反映账户的总权益（包括未实现盈亏）
- 可转出金额只反映可以实际转出的资金（不包括未实现盈亏）

## 技术说明

### 币安API字段对应关系

在币安API中：
- `WalletBalance`: 钱包余额
- `MarginBalance`: 保证金余额（钱包余额 + 未实现盈亏）
- `AvailableBalance`: 可用余额（可以用于开新仓）
- `Available for Transfer`: 可转出金额（UI显示，API中可能需要计算）

### 代码中的处理

在 `exchange/binance/adapter.go` 中：
```go
// 从币安API获取的字段
balance, _ := strconv.ParseFloat(asset.WalletBalance, 64)
available, _ := strconv.ParseFloat(asset.AvailableBalance, 64)
marginBalance, _ := strconv.ParseFloat(asset.MarginBalance, 64)
```

注意：币安API的 `AvailableBalance` 是"可用余额"（用于开新仓），不是"可转出金额"。

## 总结

**可转出金额比保证金余额少是正常现象**，主要原因：

1. ✅ **未实现盈亏不能直接转出**：只有平仓后才能转出
2. ✅ **持仓占用保证金**：持仓会占用部分资金作为保证金
3. ✅ **挂单占用保证金**：挂单也会占用部分资金
4. ✅ **系统设计**：币安的设计就是这样的，保证金余额反映总权益，可转出金额反映实际可转出的资金

**建议**：
- 如果想转出更多资金，确保所有持仓都已平仓
- 取消不需要的挂单
- 等待订单完全成交
- 此时可转出金额应该接近钱包余额
