# 日志分离实施总结

## 概述

成功实现了应用日志和 Web 框架日志的分离,两种日志现在写入不同的文件,便于问题定位和日志管理。

## 实施内容

### 1. 增强 Logger 模块 (`logger/logger.go`)

**新增功能:**
- 添加了 Web 日志专用的文件写入器和文件句柄
- 实现了 `InitWebLogger()` 函数初始化 Web 框架日志文件
- 实现了 `WriteWebLog()` 函数供 Gin 中间件写入日志
- 实现了 Web 日志的自动日期轮转功能
- 修改了应用日志文件名格式从 `quantmesh-{date}.log` 到 `app-quantmesh-{date}.log`

**技术细节:**
- Web 日志和应用日志使用独立的互斥锁,确保线程安全
- 两个日志文件都支持按日期自动轮转
- Web 日志文件路径: `logs/web-gin-{date}.log`
- 应用日志文件路径: `logs/app-quantmesh-{date}.log`

### 2. 创建自定义 Gin 日志中间件 (`web/logger_middleware.go`)

**新文件: `web/logger_middleware.go`**

**功能特性:**
- 只记录错误请求 (HTTP 状态码 >= 400)
- 记录请求的延迟时间、客户端 IP、请求方法和路径
- 如果有错误信息,一并记录
- 日志格式与 Gin 原生格式相似,保持一致性

**日志格式示例:**
```
2026/01/07 20:07:06 [GIN] 404 | 12.125µs | ::1 | GET     /notfound
2026/01/07 20:07:06 [GIN] 500 | 8.917µs | ::1 | GET     /error
```

### 3. 修改 Web 服务器初始化 (`web/server_start.go`)

**主要变更:**
- 将 `gin.Default()` 改为 `gin.New()`
- 手动添加 `gin.Recovery()` 中间件 (保留 panic 恢复功能)
- 添加自定义的 `GinLoggerMiddleware()` 中间件
- 在服务器启动前初始化 Web 日志文件

**变更对比:**
```go
// 之前
r := gin.Default() // 包含默认的 Logger + Recovery

// 之后
r := gin.New()
r.Use(gin.Recovery())           // 保留 panic 恢复
r.Use(GinLoggerMiddleware())    // 自定义错误日志
```

### 4. 修复编译错误 (`web/api_events.go`)

**问题:**
- `qmi18n.RegisterMessages` 函数不存在导致编译失败

**解决方案:**
- 临时注释掉未实现的国际化代码
- 添加 TODO 注释,待后续实现

## 测试结果

✅ **测试通过** - 所有功能正常工作:

1. **应用日志** (`logs/app-quantmesh-2026-01-07.log`):
   ```
   2026/01/07 20:07:04 [INFO] 应用启动
   2026/01/07 20:07:04 [INFO] 应用初始化完成
   2026/01/07 20:07:04 [WARN] 这是一个警告
   2026/01/07 20:07:06 [INFO] 请求处理完成
   2026/01/07 20:07:06 [ERROR] 模拟一个错误日志
   ```

2. **Web 日志** (`logs/web-gin-2026-01-07.log`):
   ```
   2026/01/07 20:07:06 [GIN] 404 | 12.125µs | ::1 | GET     /notfound
   2026/01/07 20:07:06 [GIN] 500 | 8.917µs | ::1 | GET     /error
   ```

3. **验证要点:**
   - ✅ 应用日志和 Web 日志完全分离
   - ✅ Web 日志只记录错误请求 (4xx, 5xx)
   - ✅ 成功请求 (2xx) 不会记录到 Web 日志
   - ✅ 两个日志文件都支持按日期自动轮转
   - ✅ 日志格式清晰,易于阅读和分析

## 文件变更清单

1. **`logger/logger.go`** - 添加 Web 日志支持
   - 新增变量: `webFileLogger`, `webLogFile`, `webCurrentDate`, `webFileMu`
   - 新增函数: `InitWebLogger()`, `closeWebLogger()`, `checkAndRotateWebLog()`, `WriteWebLog()`
   - 修改: 日志文件名格式,关闭逻辑

2. **`web/logger_middleware.go`** - 新建,自定义 Gin 日志中间件
   - 实现了 `GinLoggerMiddleware()` 函数

3. **`web/server_start.go`** - 修改初始化逻辑
   - 将 `gin.Default()` 改为 `gin.New()`
   - 添加自定义中间件注册

4. **`web/api_events.go`** - 修复编译错误
   - 注释掉未实现的国际化代码

## 使用说明

### 启动要求

无需额外配置,系统启动时会自动:
1. 创建 `logs/` 目录
2. 初始化 Web 日志文件
3. 应用日志根据日志级别决定是否写入文件 (DEBUG 级别启用文件日志)

### 日志文件位置

```
logs/
├── app-quantmesh-2026-01-07.log  # 应用日志
└── web-gin-2026-01-07.log        # Web 框架日志
```

### 日志轮转

- **自动轮转**: 每天午夜自动创建新的日志文件
- **命名规则**: `{prefix}-{YYYY-MM-DD}.log`
- **线程安全**: 使用互斥锁保护文件操作

### 日志级别控制

**应用日志:**
- 通过 `system.log_level` 配置项控制
- `DEBUG` 级别: 启用文件日志
- 其他级别: 只输出到控制台

**Web 日志:**
- 始终启用文件日志
- 只记录 HTTP 状态码 >= 400 的请求

## 优势

1. **清晰分离**: 应用日志和 Web 请求日志完全分离,便于问题定位
2. **减少噪音**: Web 日志只记录错误请求,减少日志量
3. **自动轮转**: 支持按日期自动轮转,便于日志管理
4. **统一格式**: 保持统一的时间戳和日志格式
5. **线程安全**: 使用互斥锁保护并发访问
6. **向后兼容**: 不影响现有的日志查看 API

## 后续改进建议

1. **配置化**: 可以将日志文件名前缀、是否记录成功请求等参数配置化
2. **日志大小限制**: 添加单个日志文件大小限制,避免文件过大
3. **自动清理**: 实现旧日志文件的自动清理机制
4. **日志级别**: 支持为 Web 日志配置不同的错误级别阈值
5. **性能优化**: 考虑使用缓冲写入减少磁盘 I/O

## 总结

日志分离功能已成功实现并通过测试。应用日志和 Web 框架日志现在写入不同的文件,且 Web 日志只记录错误请求,大大提高了日志的可读性和可维护性。

